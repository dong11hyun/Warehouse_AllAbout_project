## attack.py (동시성 확인)

> 서버(Django)가 동시에 들어오는 요청을 제대로 방어하지 못할 때, 데이터가 어떻게 꼬이는지 확인하는 코드!

```
import threading
import requests
import time
```
import threading: 파이썬에서 **동시 작업(병렬 처리)**을 하기 위한 도구입니다. 혼자서 일하는 게 아니라, '고객'과 '사장님'이라는 두 명의 일꾼을 만들기 위해 가져왔습니다.

import requests: 파이썬 코드로 웹 브라우저처럼 **API 요청(GET, PUT 등)**을 보내기 위한 라이브러리입니다.

import time: 시간 지연을 줄 때 쓰지만, 이 코드의 실행 로직에서는 직접 쓰이지 않았습니다. (보통 타이밍 조절용으로 많이 씁니다.)

`URL = "http://127.0.0.1:8000/api/v1/orders/8/"`

테스트 대상 주소: 로컬 서버(127.0.0.1)에 있는 8번 주문을 건드리겠다고 설정했습니다. 이 8번 주문이 테스트의 대상 입니다.

1. 고객 역할을 맡은 스레드가 할 일입니다.
```
def customer_cancel():
    print(" [고객] '취소해주세요!' 요청 보냄")
    res = requests.put(URL, json={'status': 'cancelled'})
    print(f" [고객] 응답 받음: {res.json()['status']}")
``` 

- customer_cancel: 고객 역할을 맡은 스레드가 할 일입니다.

- **requests.put(  ): 서버에 "이 주문 상태를 cancelled(취소)로 바꿔줘!" 라고 수정 요청(PUT)을 보냅니다. requests.put으로 HTTP PUT 요청을 보내는 것입니다.**

- res.json(): 서버가 바꿨다고 응답한 내용을 출력합니다.

2. 사장님 역할을 맡은 스레드가 할 일입니다.
```
def restaurant_accept():
    print(" [사장님] '주문 접수!' 요청 보냄")
    res = requests.put(URL, json={'status': 'preparing'})
    print(f" [사장님] 응답 받음: {res.json()['status']}")
```

- restaurant_accept: 사장님 역할을 맡은 스레드가 할 일입니다.

- requests.put(  ): 서버에 "이 주문 상태를 preparing(조리중)으로 바꿔줘!" 라고 요청합니다.

- res.json(): 서버가 바꿨다고 응답한 내용을 출력합니다.

---

`threading.Thread` 으로 스레드 배치하기

```
t1.start()
t2.start()

t1.join()
t2.join()
```

start() 로 스레드를 실행하고, join()으로 스레드가 끝날 때까지 기다립니다. **Race Condition(경쟁 상태)**을 유발합니다.

---

## settings.py 

```
from dotenv import load_dotenv
load_dotenv(BASE_DIR / '.env')
SECRET_KEY = os.getenv('SECRET_KEY', 'django-insecure-   ')
```

- python-dotenv를 사용하여 비밀번호나 키 값을 코드에서 분리하였습니다.

---

## views.py

```
class OrderV1ViewSet(viewsets.ModelViewSet):
    queryset = Order.objects.all()
    serializer_class = OrderV1Serializer
```
viewsets.ModelViewSet 상속으로 강력하고 간편한 DRF의 도구를 가져왔습니다.

**`self.get_object()` : DB에서 해당 주문(ex 8번 주문)의 정보를 가져옴**

**`new_status = request.data.get('status')` : 클라이언트(attack.py)가 보낸 JSON 데이터 중에서 'status'라는 키(Key)에 해당하는 값을 뽑아내는 코드입니다.**

`time.sleep(3)` :  동시성 테스트의 핵심이고, 결제 승인 대기, 외부 API 호출 등으로 인해 처리 시간이 걸릴 수 있습니다. 그 시간을 3초로 설정했습니다.

`order.status = new_status` : 3초 전에 가져온 메모리 객체의 상태만 바꿉니다.



`order.save()` : DB (덮어쓰고) 저장
