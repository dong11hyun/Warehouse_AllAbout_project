# [Retrospective] 시행착오와 문제 해결의 여정 (V1 to V2)

> "처음부터 완벽한 코드는 없다."
> 이 문서는 A1_NeighborBid_Auction 프로젝트를 개발하며 겪었던 주요 버그와 성능 이슈, 그리고 이를 극복하며 시스템을 고도화해 나간 **Problem-Solving 과정**을 가감 없이 기록합니다.

## 1. [Critical] 이중 지출(Double Spending) 버그

### 1.1 현상
잔액이 10,000원인 테스트 유저가 두 개의 경매창을 띄워놓고 거의 동시에 입찰 버튼을 눌렀을 때, 잔액이 -10,000원이 되는 현상을 발견했습니다. (원래는 잔액 부족으로 막혔어야 함)

### 1.2 원인 분석
전형적인 **Race Condition(경쟁 상태)**였습니다.
애플리케이션 레벨의 `if balance < amount:` 검사를 수행하는 시점에 두 요청 모두 DB에서 '10,000원 있음'을 읽어갔기 때문에 발생한 문제입니다.

### 1.3 해결 과정
*   **시도 1 (애플리케이션 락):** 파이썬의 `threading.Lock`을 써보았으나, Gunicorn의 멀티 프로세스 환경(각 프로세스가 메모리 공유 안 함)에서는 무용지물이었습니다.
*   **시도 2 (낙관적 락):** 충돌이 드물 것이라 가정하고 버전(version) 필드를 추가했으나, 마감 직전 입찰이 몰릴 때 재시도(Retry) 로직이 너무 복잡해졌습니다.
*   **최종 해결 (비관적 락):** `select_for_update`를 도입. DB 차원에서 줄을 세우는 것이 가장 확실하다는 결론을 내렸습니다. 성능 저하 우려가 있었으나, 벤치마킹 결과 동시 접속자 1,000명 수준까지는 DB 부하가 크지 않음을 확인했습니다.

---

## 2. [Performance] 웹소켓 연결 폭주와 서버 다운

### 2.1 현상
경매 리스트 페이지(메인 화면)에 들어가는 순간 브라우저가 수십 개의 웹소켓 연결을 시도하며 서버 CPU가 100%를 치는 현상이 발생했습니다.

### 2.2 원인 분석
초기 설계에서는 '경매 1개당 소켓 1개'를 연결하도록 짰습니다. 메인 화면에 경매가 20개 노출되니, 사용자 1명이 들어오면 소켓 20개를 맺어버리는 비효율적인 구조였습니다.

### 2.3 해결 과정
*   **구조 변경:** 소켓 연결은 **'페이지 당 1개'**만 맺도록 변경했습니다.
*   **멀티플렉싱(Multiplexing):** 하나의 소켓 연결 내에서 `{'type': 'subscribe', 'id': 1}`, `{'type': 'subscribe', 'id': 2}` 메시지를 보내면, 서버가 해당 유저를 여러 그룹에 넣어주는 방식으로 개선했습니다.
*   **결과:** 사용자당 연결 수가 20개 -> 1개로 줄어들며 리소스 사용량이 95% 감소했습니다.

---

## 3. [Architecture] 알림 누락과 트랜잭션의 순서

### 3.1 현상
"즉시 구매 성공" 알림을 받았는데, 새로고침해보니 상품이 여전히 '판매 중'인 기이한 현상이 간헐적으로 발생했습니다.

### 3.2 원인 분석
`buy_now` 함수에서 `channel_layer.group_send`(알림)가 `transaction.atomic` 블록 안에서 실행되었습니다. 알림은 비동기적으로 **즉시** 발송되었는데, 정작 DB 트랜잭션이 어떤 이유로(예: 마지막 검증 실패) 롤백되면서 데이터는 저장되지 않은 엇박자가 난 것입니다.

### 3.3 해결 과정
*   **트랜잭션 훅 사용:** Django의 `transaction.on_commit()`을 발견하고 적용했습니다.
*   **원칙 수립:** "사이드 이펙트(이메일, 알림 등)는 반드시 DB 커밋이 확정된 후에 실행한다"는 원칙을 세우고, 모든 비즈니스 로직을 전수 조사하여 수정했습니다.

---

## 4. 마치며: 실패는 성공의 어머니

이러한 시행착오들은 프로젝트를 더욱 견고하게 만들었습니다. 단순히 "기능이 돌아간다"에 만족하지 않고, 극한의 상황(동시성, 네트워크 지연)을 가정하고 테스트하며 얻은 경험은 코드 한 줄 한 줄에 깊이를 더해주었습니다.

> **작성자:** A1_NeighborBid_Auction 백엔드 개발팀
> **관련 문서:** [05_TESTING_STRATEGY.md](file:///c:/A1_NeighborBid_Auction/05_TESTING_STRATEGY.md)
